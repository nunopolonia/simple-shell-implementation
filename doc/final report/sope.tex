% compilar com pdflatex
\documentclass[a4paper,12pt]{report}
\usepackage[latin1]{inputenc}
\usepackage[portuges]{babel}
\usepackage[pdftex]{graphicx}
\usepackage{indentfirst}

% source code
\usepackage{listings}
\usepackage{color}
\definecolor{darkgrey}{rgb}{0.3,0.3,0.3}
\definecolor{darkgreen}{rgb}{0.0,0.3,0.0}
\definecolor{orange}{rgb}{1.0,0.65,0.0}
\definecolor{darkred}{rgb}{0.8,0.0,0.0}
\definecolor{javadoc}{rgb}{0.1,0.5,0.9}

\lstdefinestyle{cstyle}
	{language=[ANSI]C,
	extendedchars=true,
	inputencoding=latin1,
	tabsize=4,
	showstringspaces=false,
	basicstyle=\scriptsize,
	keywordstyle=\ttfamily\color{blue},
	stringstyle=\ttfamily\color{orange},
	identifierstyle=\ttfamily,
	commentstyle=\ttfamily\color{darkred},
	morecomment=[s][\ttfamily\color{javadoc}]{/**}{*/},
	numbers=left}

% PDF Hyperlinks
\usepackage{hyperref}
\usepackage{color}
\definecolor{darkblue}{rgb}{0.0,0.0,0.3}
\hypersetup{colorlinks,breaklinks,
			linkcolor=darkblue,urlcolor=darkblue,
			anchorcolor=darkblue,citecolor=darkblue}

\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{titlepage}
\begin{center}

\textsc{
Mestrado Integrado em \\Engenharia Informática e Computação\\
\ \\ % força linha em branco
\Large Sistemas Operativos\\
\small EIC0027\\
}
\vfill

\textsc{
\LARGE Relatório Final\\
\large \textit{1º Trabalho Prático: SO Shell (sosh)}\\
}
\vfill
Jorge Nuno Polónia Coelho Ferro, ei05037\\
Ricardo Daniel Pacheco Martins, ei05066\\
\vfill

\includegraphics[width=40mm]{image/feup}\\
\small
Faculdade de Engenharia da Universidade do Porto\\
Rua Dr. Roberto Frias, s/n,\\ 4200-465 Porto, Portugal
\vspace{5mm}

Porto, 1 de Novembro de 2009

\end{center}
\end{titlepage}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{abstract}
Este relatório é o complemento do culminar do projecto realizado durante o semestre no âmbito da disciplina de Sistemas Operativos. Aqui serão apresentados os resultados e documentados todos os pontos necessários para a compreensão do programa desenvolvido, programa esse que visa a implementação de um interpretador de comandos simples em C.
\end{abstract}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\tableofcontents

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Objectivos}
\begin{quote}
  "Conhecer e utilizar a interface de desenvolvimento de sistemas baseados em Unix. Nomeadamente, após a conclusão deste trabalho com sucesso, os alunos serão capazes de conseguir

  \begin{itemize}
    \item criar novos processos;
    \item fazê-los intercomunicar por sinais;
    \item percorrer um sistema de ficheiros e dele obter informações."\cite{assignment}
  \end{itemize}
\end{quote} 


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Estrutura do trabalho}

O trabalho foi dividido nos seguintes módulos
\begin{itemize}
  \item history - Módulo onde são definidas todas as funções relacionadas com a implementação do histórico;
  \item aux - Módulo onde são implementadas todas as funções auxiliares da shell;
  \item cmds - Módulos onde são implementados todos os comandos nativos da shell;
  \item sosh - Módulo principal do programa, onde é implementada a shell.
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\chapter{Funcionalidades}

Foi proposta a realização de quatro versões da sosh, com as seguintes funcionalidades. Segue-se a sua listagem e implementação.

\section{sosh 0.1}
\begin{center}
    \begin{tabular}{ | l | c | }
    \hline
      Funcionalidade & Implementada \\ \hline
      Estar em loop a receber comandos & Sim \\ \hline
      Reconhecer o comando \textit{quem} & Sim \\ \hline
      Processo pai espera por processo filho & Sim \\ \hline
      Pergunta ao receber o sinal Ctrl-C & Sim \\
    \hline
    \end{tabular}
\end{center}

\section{sosh 0.2}
\begin{center}
    \begin{tabular}{ | l | c | }
    \hline
      Funcionalidade & Implementada \\ \hline
      Reconhecer o comando \textit{quem} & Sim \\ \hline
      Reconhecer o comando \textit{psu} & Sim \\ \hline
      Reconhecer o comando \textit{ver} & Sim \\ \hline
      Reconhecer o comando \textit{ajuda} & Sim \\ \hline
      Reconhecer o comando \textit{localiza cmd} & Sim \\ \hline
      Reconhecer o comando \textit{exit} & Sim \\
    \hline
  \end{tabular}
\end{center}

\section{sosh 0.3a}
\begin{center}
    \begin{tabular}{ | l | c | }
    \hline
      Funcionalidade & Implementada \\ \hline
      Reconhecer as aplicações localizadas em /usr/bin & Sim \\ \hline
      Organização dos comandos da sosh no módulo cmds & Sim \\
    \hline
  \end{tabular}
\end{center}

\section{sosh 0.3b}
\begin{center}
    \begin{tabular}{ | l | c | }
    \hline
      Funcionalidade & Implementada \\ \hline
      Reconhecer o comando \textit{hist} & Sim \\ \hline
      Reconhecer o comando \textit{!string} & Sim \\
    \hline
  \end{tabular}
\end{center}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Detalhes de Implementação}

\section{Principais funções}
Para os membros do grupo, as principais funções deste trabalho, tanto pelo seu nivel de complexidade como pela qualidade da solução encontrada são, por ordem

\begin{enumerate}
  \item \textit{Comando localiza cmd}
  \item \textit{Comando hist}
  \item \textit{Comando !string}
  \item \textit{Aplicações localizadas em /usr/bin}
\end{enumerate} 

De modo a implementá-las, foram usadas as seguintes abordagens.

\subsection{Comando localiza cmd}
Ao chamar a função na sosh, é chamada a função \textit{cmd\_localiza} definido em \textit{cmds.h}, tendo sido alterada a sua definição para incluir como parametro cmd, que se trata de toda a linha introduzida pelo utilizador.\\ 
Uma vez que este trabalho é académico, é incluido na função \textit{cmd\_localiza} um path inicial de modo a tornar testes e demonstrações mais simples.\\
Esta função \textit{cmd\_localiza} retira do parametro cmd os caracteres "localiza " chamando de seguida a função \textit{depthsearch} que, como o próprio nome indica, realiza uma pesquisa em profundidade na árvore de ficheiros. Quando encontra um directório que inclui a \textit{string} desejada pelo utilizador chama a função auxiliar \textit{print\_tree\_below} que imprime todo o ramo da árvore de ficheiros abaixo desse directório, uma vez que nesse ramo, todos os ficheiros vão conter a \textit{string} pesquisada pelo utilizador no seu \textit{path} absoluto.\\
Se encontra um directório que não possui a \textit{string} desejada pelo utilizador, faz um \textit{fork} que realiza uma chamada recursiva da função para esse directório continuando assim a sua busca em profundidade.\\
É tido o cuidado de verificar se os directórios não são \textit{symlinks}, o que faria o programa entrar em ciclo (código fonte na página \pageref{locatecmd}).

\subsection{Comando hist}
O histórico é implementado recorrendo a uma lista duplamente ligada implementada no módulo \textit{history} inicializada num \textit{scope} global. De cada vez que um comando é introduzido, é acrescentado ao final dessa lista sendo essa mesma lista percorrida através dos apontadores \textit{next} e \textit{previous} presentes em cada nó (código fonte na página \pageref{histcmd}).

\subsection{Comando !string}
O programa foi construido de modo a ter uma função (\textit{soshreadline}) que recebe o input do utilizador, trata-o e devolve ao corpo principal da aplicação a "\textit{string} limpa" que despoleta a chamada da função. No interior dessa função, se o input começar por um ponto de exclamação, é feita uma pesquisa no histórico por um comando previamente introduzido que possua a \textit{string} fornecida pelo utilizador. Caso encontre, passa esse comando ao corpo principal da aplicação para despoletar a chamada da função correspondente, adicionando esse comando ao histórico e não a pesquisa introduzida pelo utilizador (código fonte na página \pageref{searchcmd}).

\subsection{Aplicações localizadas em /usr/bin}
Esta função foi realizada utilizando uma implementação de uma função denominada \textit{makeargv} presente no livro Unix Systems Programming\cite{unixsystemprog}, que recebe uma \textit{string} dividindo-a em \textit{tokens} construindo um \textit{array} de \textit{strings} que é de seguida passado à função \textit{execv}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Conclusões}
Após um período de investigação antes da fase de programação, foi marcada como função com grau de dificuldade mais elevado a função \textit{localiza cmd}.\\
Essa função exigiu um planeamento mais detalhado, uma vez que com as mudanças de \textit{path} e com os sucessivos \textit{forks}, o output tornava-se bastante complexo, o que fazia com que fosse necessário ter sempre a noção de cada passo da função. Estas dificuldades foram debeladas introduzindo no código produzido \textit{error handling} em todas as chamadas ao sistema tornando-o por isso muito verboso no caso de eventuais erros.\\
Foram utilizadas as bibliotecas  \textit{GNU readline} e \textit{GNU history} numa fase inicial do projecto, tendo sido posteriormente abandonadas após uma conversa com o docente, uma vez que esse impedimento não se encontrava discriminado no enunciado. Esse factor alterou a marcação do grau de dificuldade das funções \textit{hist} e \textit{!string} no plano de desenvolvimento e obrigou também a uma reestruturação do código do programa.\\
No final, o grupo considera que foram concluídas com sucesso todas as etapas deste trabalho devendo-se isso a um planeamento  e investigação cuidadosos em vez de programação errática. Apesar de todas as etapas terem sido concluídas, todos os objectivos elaborados nesse planeamento não foram cumpridos, havendo por isso possibilidade de melhoramentos numa versão futura(ver cap. \ref{improvements}).\\


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Melhoramentos}
\label{improvements}
No final deste desenvolvimento, usando o comando \\
\begin{verbatim}
  grep -R TODO *
\end{verbatim}
verificam-se duas situações marcadas como necessitando de melhoramento durante o desenvolvimento.\\
A primeira delas prende-se com a pergunta ao utilizador aquando da recepção do ctrl-c. O planeamento exigia que a função fosse \textit{async signal safe} usando para isso apenas funções que o fossem como o write e o read e evitando funções que não o fossem como o strcmp. Esse objectivo não foi cumprido, não havendo um controlo total sobre o input do utilizador controlando o programa apenas inputs de uma letra.\\
A segunda situação prende-se com o sinal enviado para a finalização do programa.\\
Além disto, o grupo considera a utilização das bibliotecas GNU readline e GNU history um melhoramento ao programa uma vez que expandiria em muito as funcionalidades da sosh. Podem ser verificados estes melhoramentos na branch \textit{master} do sistema de controlo de versões utilizado pelo grupo(ver cap. \ref{development}) estando implementadas todas as funcionalidades do programa excepto a função \textit{localiza cmd}.\\
 
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\chapter{Ambiente de desenvolvimento}
\label{development}

Este projecto foi desenvolvido usando os seguintes recursos:

\begin{itemize}
	\item Sistema Opertativo: GNU/Linux
	\item Linguagem: C
  \item Sistema de controlo de versões: Git (git://github.com/nunopolonia/sope\_tp1.git)
	\item Sistema tipográfico para preparação de documentos: \LaTeX
	\item Ver Bibliografia (pág. \pageref{bibliografia})
\end{itemize}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

%plain, plainnat, unsrt, abbrv, alpha
\bibliographystyle{plain}
\bibliography{sope}
\label{bibliografia}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


\chapter{Anexos}

\section{Declaração de autoria}
Declaramos sob compromisso de honra que este trabalho, nas suas partes constituintes de código e relatório, é original e da nossa autoria, não correspondendo, portanto, a cópia ou tradução de outros trabalhos já realizados, na FEUP ou fora dela.\\
Mais declaramos que todos os documentos ou código que serviram de base ao desenvolvimento do trabalho descrito no relatório e seus anexos são adequadamente citados e explicitados na respectiva secção de referências bibliográficas e que todas as eventuais partes transcritas ou utilizadas de outras fontes estão devidamente assinaladas, identificadas e evidenciadas.\\

\begin{flushright}
Os autores,\\
Jorge Nuno Polónia Coelho Ferro\\
Ricardo Daniel Pacheco Martins\\
\end{flushright} 

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newpage
\section{Comando localiza cmd}
\label{locatecmd}
\lstinputlisting[style=cstyle]{source/localiza.c}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newpage
\section{Comando hist}
\label{histcmd}
\lstinputlisting[style=cstyle]{source/hist.c}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\newpage
\section{Comando !string}
\label{searchcmd}
\lstinputlisting[style=cstyle]{source/search.c}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%



\end{document}
